<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>FreeRTOS 调度器开启和任务相关函数详解 | yphfree的学习笔记</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">FreeRTOS 调度器开启和任务相关函数详解</h1><a id="logo" href="/.">yphfree的学习笔记</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">FreeRTOS 调度器开启和任务相关函数详解</h1><div class="post-meta">Jan 19, 2018<span> | </span><span class="category"><a href="/categories/FreeRTOS/">FreeRTOS</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#调度器开启过程分析"><span class="toc-number">1.</span> <span class="toc-text">调度器开启过程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#任务调度器开启函数分析"><span class="toc-number">1.1.</span> <span class="toc-text">任务调度器开启函数分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内核相关硬件初始化函数分析"><span class="toc-number">1.2.</span> <span class="toc-text">内核相关硬件初始化函数分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动第一个任务"><span class="toc-number">1.3.</span> <span class="toc-text">启动第一个任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SVC-中断服务函数"><span class="toc-number">1.4.</span> <span class="toc-text">SVC 中断服务函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#空闲任务"><span class="toc-number">1.5.</span> <span class="toc-text">空闲任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#任务创建过程分析"><span class="toc-number">2.</span> <span class="toc-text">任务创建过程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#任务创建函数分析"><span class="toc-number">2.1.</span> <span class="toc-text">任务创建函数分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#任务初始化函数分析"><span class="toc-number">2.2.</span> <span class="toc-text">任务初始化函数分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#任务堆栈初始化函数分析"><span class="toc-number">2.3.</span> <span class="toc-text">任务堆栈初始化函数分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#添加任务到就绪列表"><span class="toc-number">2.4.</span> <span class="toc-text">添加任务到就绪列表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#任务删除过程分析"><span class="toc-number">3.</span> <span class="toc-text">任务删除过程分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#任务挂起过程分析"><span class="toc-number">4.</span> <span class="toc-text">任务挂起过程分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#任务恢复过程分析"><span class="toc-number">5.</span> <span class="toc-text">任务恢复过程分析</span></a></li></ol></div></div><div class="post-content"><p>一个操作系统最核心的内容就是多任务管理，所以我们非常有必要去学习一下 FreeRTOS 的任务创建、删除、挂起、恢复和系统启动等，这样才能对 FreeRTOS 有一个更深入的了解。    </p>
<ul>
<li>调度器开启过程分析</li>
<li>任务创建过程分析</li>
<li>任务删除过程分析</li>
<li>任务挂起过程分析</li>
<li>任务恢复过程分析<a id="more"></a>  
</li>
</ul>
<h2 id="调度器开启过程分析"><a href="#调度器开启过程分析" class="headerlink" title="调度器开启过程分析"></a>调度器开启过程分析</h2><p>涉及到 ARM 的汇编指令，有关涉及到的 ARM 指令的详细使用情况请参考《权<br>威指南》的“第 5 章 指令集”。《权威指南》的这一章节对 Cortex-M3/M4 内核的所有指令做了<br>非常详细的接收，包括指令的含义、使用方法和参考案例。</p>
<h3 id="任务调度器开启函数分析"><a href="#任务调度器开启函数分析" class="headerlink" title="任务调度器开启函数分析"></a>任务调度器开启函数分析</h3><p>函数 vTaskStartScheduler()的功能就是开启任务调度器的，这个函数在文件 tasks.c中有定义</p>
<p>(1)、创建空闲任务，如果使用静态内存的话使用函数 xTaskCreateStatic()来创建空闲任务，优先级为 tskIDLE_PRIORITY，宏 tskIDLE_PRIORITY 为 0，也就是说空闲任务的优先级为最<br>低。    </p>
<p>(2)、如果使用软件定时器的话还需要通过函数 xTimerCreateTimerTask()来创建定时器服务任务。定时器服务任务的具体创建过程是在函数 xTimerCreateTimerTask()中完成的。      </p>
<p>(3)、关闭中断，在 SVC 中断服务函数 vPortSVCHandler()中会打开中断。         </p>
<p>(4)、变量 xSchedulerRunning 设置为 pdTRUE，表示调度器开始运行。        </p>
<p>(5)、当宏 configGENERATE_RUN_TIME_STATS 为 1 的时候说明使能时间统计功能，此时需要用户实现宏 portCONFIGURE_TIMER_FOR_RUN_TIME_STATS，此宏用来配置一个定时器/计数器。         </p>
<p>(6)、调用函数 xPortStartScheduler()来初始化跟调度器启动有关的硬件，比如滴答定时器、<br>FPU 单元和 PendSV 中断等等。     </p>
<h3 id="内核相关硬件初始化函数分析"><a href="#内核相关硬件初始化函数分析" class="headerlink" title="内核相关硬件初始化函数分析"></a>内核相关硬件初始化函数分析</h3><p>FreeRTOS 系统时钟是由滴答定时器来提供的，而且任务切换也会用到 PendSV 中断，这些<br>硬件的初始化由函数 xPortStartScheduler()来完成，</p>
<h3 id="启动第一个任务"><a href="#启动第一个任务" class="headerlink" title="启动第一个任务"></a>启动第一个任务</h3><p>经过上面的操作以后我们就可以启动第一个任务了，函数 prvStartFirstTask()用于启动第一个任务，这是一个汇编函数，</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">__asm</span> void prvStartFirstTask( void )</span><br><span class="line">&#123;</span><br><span class="line">	<span class="meta">PRESERVE8</span></span><br><span class="line">	<span class="keyword">ldr </span><span class="built_in">r0</span>, <span class="number">=0xE000ED08</span>    <span class="comment">;R0=0XE000ED08                   (1)</span></span><br><span class="line">	<span class="keyword">ldr </span><span class="built_in">r0</span>, [<span class="built_in">r0</span>]           <span class="comment">;取 R0 所保存的地址处的值赋给 R0 (2)</span></span><br><span class="line">	<span class="keyword">ldr </span><span class="built_in">r0</span>, [<span class="built_in">r0</span>]           <span class="comment">;获取 MSP 初始值                 (3)</span></span><br><span class="line">	<span class="keyword">msr </span>msp, <span class="built_in">r0</span>            <span class="comment">;复位 MSP                        (4)</span></span><br><span class="line">	<span class="keyword">cpsie </span>I                <span class="comment">;使能中断(清除 PRIMASK)          (5)</span></span><br><span class="line">	<span class="keyword">cpsie </span>f                <span class="comment">;使能中断(清除 FAULTMASK)        (6)</span></span><br><span class="line">	<span class="keyword">dsb </span>                   <span class="comment">;数据同步屏障                    (7)</span></span><br><span class="line">	<span class="keyword">isb </span>                   <span class="comment">;指令同步屏障                    (8)</span></span><br><span class="line">	<span class="keyword">svc </span><span class="number">0</span>                  <span class="comment">;触发 SVC 中断(异常)             (9)</span></span><br><span class="line">	<span class="keyword">nop</span></span><br><span class="line"><span class="keyword">	</span><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure>
<p>(1)、将 0XE000ED08 保存在寄存器 R0 中。一般来说向量表应该是从起始地址(0X00000000)开始存储的，不过，有些应用可能需要在运行时修改或重定义向量表， Cortex-M 处理器为此提供了一个叫做向量表重定位的特性。向量表重定位特性提供了一个名为向量表偏移寄存器(VTOR)的可编程寄存器。 VTOR 寄存器的地址就是 0XE000ED08，通过这个寄存器可以重新定义向量表，比如在 STM32F103 的 ST 官方库中会通过函数 SystemInit()来设置 VTOR 寄存器，代码如下：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SCB-&gt;VTOR = FLASH_BASE | VECT_TAB_OFFSET; <span class="comment">//VTOR=0x08000000+0X00</span></span><br></pre></td></tr></table></figure></p>
<p>通过上面一行代码就将向量表开始地址重新定义到了 0X08000000，向量表的起始地址存储的就是 MSP 初始值。关于向量表和向量表重定位的详细内容请参阅《权威指南》的“第7章异常和中断”的 7.5 小节。</p>
<p>(2)、读取 R0 中存储的地址处的数据并将其保存在 R0 寄存器，也就是读取寄存器 VTOR中的值，并将其保存在 R0 寄存器中。这一行代码执行完就以后 R0 的值应该为 0X08000000。          </p>
<p>(3)、读取 R0 中存储的地址处的数据并将其保存在 R0 寄存器，也就是读取地址 0X08000000处存储的数据，并将其保存在 R0 寄存器中。我们知道向量表的起始地址保存的就是主栈指针MSP 的初始值，这一行代码执行完以后寄存器 R0 就存储 MSP 的初始值。现在来看(1)、 (2)、(3)这三步起始就是为了获取 MSP 的初始值而已！     </p>
<p>(4)、复位 MSP， R0 中保存了 MSP 的初始值，将其赋值给 MSP 就相当于复位 MSP。                   </p>
<p>(5)和(6)、使能中断。 </p>
<p>(7)和(8)、数据同步和指令同步屏障。     </p>
<p>(9)，调用 SVC 指令触发 SVC 中断， SVC 也叫做请求管理调用， SVC 和 PendSV 异常对于OS 的设计来说非常重要。 SVC 异常由 SVC 指令触发。在 FreeRTOS 中仅仅使用 SVC 异常来启动第一个任务，后面的程序中就再也用不到 SVC 了     </p>
<h3 id="SVC-中断服务函数"><a href="#SVC-中断服务函数" class="headerlink" title="SVC 中断服务函数"></a>SVC 中断服务函数</h3><p>在函数 prvStartFirstTask()中通过调用 SVC 指令触发了 SVC 中断，而第一个任务的启动就是在 SVC 中断服务函数中完成的， SVC 中断服务函数应该为 SVC_Handler()，但是FreeRTOSConfig.h 中通过#define 的方式重新定义为了 xPortPendSVHandler()，如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> xPortPendSVHandler PendSV_Handler</span></span><br></pre></td></tr></table></figure></p>
<h3 id="空闲任务"><a href="#空闲任务" class="headerlink" title="空闲任务"></a>空闲任务</h3><p>函数 vTaskStartScheduler( )会创建一个名为“ IDLE”的任务，这个任务叫做空闲任务。顾名思义，空闲任务就是空闲的时候运行的任务，也就是系统中其他的任务由于各种原因不能运行的时候空闲任务就在运行。空闲任务是 FreeRTOS 系统自动创建的，不需要用户手动创建。任务调度器启动以后就必须有一个任务运行！但是空闲任务不仅仅是为了满足任务调度器启动以后至少有一个任务运行而创建的，空闲任务中还会去做一些其他的事情，如下：      </p>
<p>1、判断系统是否有任务删除，如果有的话就在空闲任务中释放被删除任务的任务堆栈和任<br>务控制块的内存。<br>2、运行用户设置的空闲任务钩子函数。<br>3、判断是否开启低功耗 tickless 模式，如果开启的话还需要做相应的处理空闲任务的任务优先级是最低的，为 0，任务函数为 prvIdleTask()。</p>
<h2 id="任务创建过程分析"><a href="#任务创建过程分析" class="headerlink" title="任务创建过程分析"></a>任务创建过程分析</h2><h3 id="任务创建函数分析"><a href="#任务创建函数分析" class="headerlink" title="任务创建函数分析"></a>任务创建函数分析</h3><h3 id="任务初始化函数分析"><a href="#任务初始化函数分析" class="headerlink" title="任务初始化函数分析"></a>任务初始化函数分析</h3><h3 id="任务堆栈初始化函数分析"><a href="#任务堆栈初始化函数分析" class="headerlink" title="任务堆栈初始化函数分析"></a>任务堆栈初始化函数分析</h3><h3 id="添加任务到就绪列表"><a href="#添加任务到就绪列表" class="headerlink" title="添加任务到就绪列表"></a>添加任务到就绪列表</h3><h2 id="任务删除过程分析"><a href="#任务删除过程分析" class="headerlink" title="任务删除过程分析"></a>任务删除过程分析</h2><h2 id="任务挂起过程分析"><a href="#任务挂起过程分析" class="headerlink" title="任务挂起过程分析"></a>任务挂起过程分析</h2><h2 id="任务恢复过程分析"><a href="#任务恢复过程分析" class="headerlink" title="任务恢复过程分析"></a>任务恢复过程分析</h2></div><div class="tags"><a href="/tags/FreeRTOS/">FreeRTOS</a></div><div class="post-nav"><a class="pre" href="/2018/04/10/Python/numpy/Numpy学习笔记/">Numpy学习笔记</a><a class="next" href="/2018/01/18/RTOS/FreeRTOS/FreeRTOS 任务切换/">FreeRTOS 任务切换</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C语言学习/">C语言学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/FreeRTOS/">FreeRTOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Numpy学习笔记/">Numpy学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PyQt5快速开发与实战/">PyQt5快速开发与实战</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python学习笔记/">Python学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/STM32学习笔记/">STM32学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/单片机/">单片机</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/嵌入式C-C-学习笔记/">嵌入式C/C++学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/嵌入式开发学习笔记/">嵌入式开发学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/硬件学习笔记/">硬件学习笔记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/嵌入式软件/" style="font-size: 15px;">嵌入式软件</a> <a href="/tags/C-算法/" style="font-size: 15px;">C 算法</a> <a href="/tags/硬件基础/" style="font-size: 15px;">硬件基础</a> <a href="/tags/锂电池/" style="font-size: 15px;">锂电池</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Python3/" style="font-size: 15px;">Python3</a> <a href="/tags/通信协议/" style="font-size: 15px;">通信协议</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/嵌入式项目/" style="font-size: 15px;">嵌入式项目</a> <a href="/tags/C51/" style="font-size: 15px;">C51</a> <a href="/tags/STM32基础/" style="font-size: 15px;">STM32基础</a> <a href="/tags/PyQt5/" style="font-size: 15px;">PyQt5</a> <a href="/tags/Python-Numpy/" style="font-size: 15px;">Python Numpy</a> <a href="/tags/FreeRTOS/" style="font-size: 15px;">FreeRTOS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/04/10/Python/numpy/Numpy学习笔记/">Numpy学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/19/RTOS/FreeRTOS/FreeRTOS 调度器开启和任务相关函数详解/">FreeRTOS 调度器开启和任务相关函数详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/18/RTOS/FreeRTOS/FreeRTOS 任务切换/">FreeRTOS 任务切换</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/18/RTOS/FreeRTOS/FreeRTOS 列表和列表项/">FreeRTOS 列表和列表项</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/16/Python/Python 3 正则表达式/">Python3基础  正则表达式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/15/RTOS/FreeRTOS/FreeRTOS 任务相关API函数/">FreeRTOS任务相关API函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/24/UAV/无人机基础知识总结/">无人机基础知识总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/17/HardWare/TI锂离子电池组管理器-电量监测计BQ40Z50-R1学习笔记/">TI锂离子电池组管理器 电量监测计BQ40Z50-R1学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/17/HardWare/TI单节电量计基本介绍/">TI单节电量计基本介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/14/HardWare/锂电池充电电压与充电电流设定/">锂电池充电电压与充电电流设定</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">yphfree的学习笔记.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>