<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>汽车控制器(ECU)统一诊断服务基础知识 | yphfree的学习笔记</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">汽车控制器(ECU)统一诊断服务基础知识</h1><a id="logo" href="/.">yphfree的学习笔记</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">汽车控制器(ECU)统一诊断服务基础知识</h1><div class="post-meta">Nov 14, 2018<span> | </span><span class="category"><a href="/categories/统一诊断服务UDS/">统一诊断服务UDS</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#统一诊断服务简介"><span class="toc-number">1.</span> <span class="toc-text">统一诊断服务简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Diagnostic-request的格式："><span class="toc-number">1.1.</span> <span class="toc-text">Diagnostic request的格式：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Diagnostic-response的格式："><span class="toc-number">1.2.</span> <span class="toc-text">Diagnostic response的格式：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDS定义的诊断服务从逻辑分类："><span class="toc-number">2.</span> <span class="toc-text">UDS定义的诊断服务从逻辑分类：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Diagnostic-and-Communication-Management-类诊断服务"><span class="toc-number">3.</span> <span class="toc-text">Diagnostic and Communication Management 类诊断服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DiagnosticSessionControl-0x10"><span class="toc-number">3.1.</span> <span class="toc-text">DiagnosticSessionControl (0x10)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ECUReset-0x11"><span class="toc-number">3.2.</span> <span class="toc-text">ECUReset (0x11)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SecurityAccess-0x27"><span class="toc-number">3.3.</span> <span class="toc-text">SecurityAccess (0x27)</span></a></li></ol></li></ol></div></div><div class="post-content"><h3 id="统一诊断服务简介"><a href="#统一诊断服务简介" class="headerlink" title="统一诊断服务简介"></a>统一诊断服务简介</h3><p>统一诊断服务,Unified diagnostic services(UDS)<br>UDS由ISO-14229系列标准定义，<br>ISO 14229-1定义了诊断服务，不涉及网络及实现，只有应用层的内容。<br>ISO 14229-3则定义了UDS在CAN总线上的实现。</p>
<p>诊断通信的过程就是诊断仪和ECU交换数据，诊断仪发送诊断请求(request)，ECU给出诊断响应（response），而UDS最重要的作用就是定义了这些request和response的格式和内容。</p>
<h4 id="Diagnostic-request的格式："><a href="#Diagnostic-request的格式：" class="headerlink" title="Diagnostic request的格式："></a>Diagnostic request的格式：</h4><p>Diagnostic request的格式可以分为两类：<br>一类是拥有sub-function的，<br>另一类是没有sub-function的，如下面两张图所示。</p>
<p>Service ID(以下简称SID)的长度固定为1个字节，代表了这条诊断命令执行的什么功能。sub-function的长度也是1个字节，它通常表示对这个诊断服务的具体操作，比如是启动、停止还是查询这个诊断服务。而后面的parameter则根据各个诊断服务的不同具有不同的内容，长度和格式并没有统一规格，它用于限定诊断服务执行的条件，比如某个诊断服务执行的时间等。parameter的一个重要应用是作为标识符，标识诊断请求要读出的数据内容，我会在后续的文章里详细讲述各个诊断服务的应用。</p>
<p>sub-function严格来说是7个bit，而不是1个byte，因为它的最高位bit被用于抑制正响应（suppress positive response,SPR），如果这个bit被置1，则ECU不会给出正响应（positive response）； 如果这个bit被置0，则ECU会给出正响应。这样做的目的是可以告诉ECU不要发不必要的response，从而节约通信资源。</p>
<h4 id="Diagnostic-response的格式："><a href="#Diagnostic-response的格式：" class="headerlink" title="Diagnostic response的格式："></a>Diagnostic response的格式：</h4><p>Diagnostic response分为positive和negative两类。</p>
<p>positive response意味着诊断仪发过来的诊断请求被执行了，而negative response则意味着ECU因为某种原因无法执行诊断仪发过来的诊断请求，而无法执行的原因则存在于negative response的报文中。</p>
<p><strong>positive response</strong>的格式如上图所示，也基本上是由三部分组成，其中的response SID这个字节作为诊断请求的echo，它等于SID + 0X40。后面的两个部分则视具体的诊断服务而定。</p>
<p><strong>negative response</strong>的格式固定为3个字节，第一个字节为0x7F，第二个字节是被拒绝掉的SID，第三个字节是这个诊断服务无法被执行的原因。下面这张图列举了部分原因代码，比如，如果ECU给出7F 22 13这个negative response，则说明22这个服务因为诊断请求数据长度不对的原因无法执行。</p>
<p><img src="https://pic2.zhimg.com/80/v2-124adf58d109e2a0042eca8b775194d5_hd.jpg" alt="此处输入图片的描述"></p>
<h3 id="UDS定义的诊断服务从逻辑分类："><a href="#UDS定义的诊断服务从逻辑分类：" class="headerlink" title="UDS定义的诊断服务从逻辑分类："></a>UDS定义的诊断服务从逻辑分类：</h3><ul>
<li>Diagnostic and Communication Management （诊断和通信管理）</li>
<li>Data Transmission （数据传输）</li>
<li>Stored Data Transmission （存储数据传输，用于操作DTC）</li>
<li>InputOutput Control （IO控制）</li>
<li>Routine Control （不知如何翻译好，作用是调用ECU内部的预置函数）</li>
<li>Upload Download （上传下载）</li>
</ul>
<p>UDS规定使用1个byte来表示诊断服务，即所谓的Service ID,简称SID。</p>
<h3 id="Diagnostic-and-Communication-Management-类诊断服务"><a href="#Diagnostic-and-Communication-Management-类诊断服务" class="headerlink" title="Diagnostic and Communication Management 类诊断服务"></a>Diagnostic and Communication Management 类诊断服务</h3><h4 id="DiagnosticSessionControl-0x10"><a href="#DiagnosticSessionControl-0x10" class="headerlink" title="DiagnosticSessionControl (0x10)"></a>DiagnosticSessionControl (0x10)</h4><p>DiagnosticSessionControl这个服务非常简单，但是它却是ECU和诊断通信的第一条诊断命令。服务的SID是0x10，request固定为2个byte，第、一个byte是SID，第二个byte的低7bit是sub-function，用于指示ECU将进入的session。UDS定义的session包括：</p>
<p>0x00 ISOSAEReserved（保留）<br><strong>0x01 defaultSession<br>0x02 ProgrammingSession<br>0x03 extendedDiagnosticSession<br>0x04 safetySystemDiagnosticSession</strong><br>0x05 – 0x3F ISOSAEReserved（保留）<br>0x40 – 0x5F vehicleManufacturerSpecific（由整车厂自定义使用）<br>0x60 – 0x7E systemSupplierSpecific（由ECU供应商自定义使用）<br>0x7F ISOSAEReserved（保留）</p>
<p>DiagnosticSessionControl用于控制ECU在不同的session之间进行转换，session可以看作是ECU所处的一种软件状态，在不同的session中诊断服务执行的权限不同。 ECU上电之后，默认处在defaultSession中，在这个session中很多诊断服务不可以执行，很多诊断相关的数据不能读取或写入。一般的诊断仪启动之后，会给ECU发送10 03，即让ECU进入 extendedDiagnosticSession中，在这个session中可执行的诊断服务就很多了。而如果要让ECU保持在non-defaultSession中，则需要诊断仪每隔固定的时间发送0x3E服务，ECU才会知道诊断仪有和自己通信的需求，从而保持在non-defaultSession中。</p>
<p>另一个常用的session是ProgrammingSession，在这个session中可以进行软件刷写的一系列诊断服务。0x40 – 0x5F 这个范围中的session由整车厂自定义使用，比如，某些诊断服务或诊断数据的操作需要在生产线上执行，即所谓的End-Of-Line，整车厂可以从这个范围中选择一个值来表示EOL session；又或者在开发阶段需要某种“超级”session，则也可以从这里选一个值用来使ECU进入开发模式的session。</p>
<p>这个诊断服务的response分为三部分，<br>第一部分是0x50，作为SID的echo；<br>第二部分是进入的session，作为sub-function的echo；<br>第三部分是4个字节，前两个字节代表P2Server_max，即ECU在应用层上对诊断命令的响应时间，后两个字节代表 P2 * Server_max，即ECU在暂时无法处理当前诊断命令（具体表现为发送了NRC 0X78），在应用层上对诊断命令响应的最长时间。</p>
<h4 id="ECUReset-0x11"><a href="#ECUReset-0x11" class="headerlink" title="ECUReset (0x11)"></a>ECUReset (0x11)</h4><p>ECUReset 这条指令的用途是通过诊断请求使ECU重启。</p>
<p>ECUReset 这个服务的SID是0x11，request固定为2个byte，第一个byte是SID，第二个byte的低7bit是sub-function，用于指示ECU将模拟哪种方式进行重启。</p>
<p>常用的sub-function包括</p>
<p><strong>0x01 hardReset 模拟KL30的重启</strong>  </p>
<p><strong>0x02 keyOffOnReset 模拟KL15的重启</strong>      </p>
<p>当我们通过诊断命令改写了ECU的某些数据，或者对ECU进行了某些设置，只有将ECU重启才能将这些配置生效，所以就有了这个诊断命令。在ECUReset 执行之后，ECU会从Non-defaultsession回退到defaultsession中。</p>
<h4 id="SecurityAccess-0x27"><a href="#SecurityAccess-0x27" class="headerlink" title="SecurityAccess (0x27)"></a>SecurityAccess (0x27)</h4><p>厂家可能会为ECU定义某些安全级别稍微高一些的诊断服务，在执行此类服务之前，就需要执行SecurityAccess 这个诊断命令，进行一个简单的身份验证。</p>
<p>完成SecurityAccess 有以下步骤：</p>
<p>1、诊断仪向ECU请求“Seed”（通常是一个与时间相关的伪随机数）,<br>2、ECU向诊断仪发送“Seed”,<br>3、诊断仪向ECU发送“Key” (根据请求得到的Seed和一个本地的密码进行计算得来)<br>4、ECU判断诊断仪发来的“Key”是否有效</p>
<p>根据UDS的定义，<br>0x03, 0x05, 0x07 – 0x41 这个范围留给用于requestSeed的sub-function；<br>0x04, 0x06, 0x08 – 0x42这个范围留给用于sendKey的sub-function。</p>
<p>假设SecurityAccess的诊断命令中，0x05用于requestSeed，0x06用于sendKey, 。</p>
<p>诊断仪发送 27 05</p>
<p>ECU响应 67 05 01 01 01（seed是 01 01 01）</p>
<p>诊断仪发送 27 06 02 03 04（key值是02 03 04，seed是 01 01 01，假设本地密码为01 02 03，而算法就是将密码与seed相加）</p>
<p>ECU验证成功 67 06</p>
<p>此时ECU就处于unlocked的状态了，那些被保护起来的诊断服务和诊断数据可以被操作了。通常来说，如果ECU重启，或者回到了default session，unlocked状态就失效了，如果要执行相关诊断服务，则需要再次执行上面描述的过程。</p>
</div><div class="tags"><a href="/tags/统一诊断服务UDS/">统一诊断服务UDS</a></div><div class="post-nav"><a class="pre" href="/2018/11/23/SoftWare_skills/Finite_State_Machine/用状态机原理进行软件设计——FSM概念/">用状态机原理进行软件设计——FSM概念</a><a class="next" href="/2018/11/04/QRS/AutomotiveSoftware/Diagnostic/汽车ECU诊断基本概念/">汽车ECU诊断基本概念</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android学习笔记/">Android学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CC2540/">CC2540</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C语言学习/">C语言学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/FreeRTOS/">FreeRTOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Numpy学习笔记/">Numpy学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PyQt5快速开发与实战/">PyQt5快速开发与实战</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python学习笔记/">Python学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/S3C2440学习笔记/">S3C2440学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/STM32学习笔记/">STM32学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/单片机/">单片机</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/嵌入式开发学习笔记/">嵌入式开发学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构与算法之美学习笔记/">数据结构与算法之美学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/汽车总线/">汽车总线</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/汽车电子学习笔记/">汽车电子学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/汽车电子开发学习笔记/">汽车电子开发学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/硬件学习笔记/">硬件学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/统一诊断服务UDS/">统一诊断服务UDS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/软件开发/">软件开发</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Python-Numpy/" style="font-size: 15px;">Python Numpy</a> <a href="/tags/硬件基础/" style="font-size: 15px;">硬件基础</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/锂电池/" style="font-size: 15px;">锂电池</a> <a href="/tags/Python3/" style="font-size: 15px;">Python3</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/PyQt5/" style="font-size: 15px;">PyQt5</a> <a href="/tags/嵌入式基础知识-硬件基础知识/" style="font-size: 15px;">嵌入式基础知识 硬件基础知识</a> <a href="/tags/嵌入式基础知识/" style="font-size: 15px;">嵌入式基础知识</a> <a href="/tags/STM32基础/" style="font-size: 15px;">STM32基础</a> <a href="/tags/通信协议/" style="font-size: 15px;">通信协议</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/S3C2440/" style="font-size: 15px;">S3C2440</a> <a href="/tags/STM32项目/" style="font-size: 15px;">STM32项目</a> <a href="/tags/嵌入式基础知识-通信协议/" style="font-size: 15px;">嵌入式基础知识, 通信协议</a> <a href="/tags/嵌入式基础知识-通信协议/" style="font-size: 15px;">嵌入式基础知识 通信协议</a> <a href="/tags/CC2540/" style="font-size: 15px;">CC2540</a> <a href="/tags/有限状态机/" style="font-size: 15px;">有限状态机</a> <a href="/tags/C51/" style="font-size: 15px;">C51</a> <a href="/tags/FreeRTOS/" style="font-size: 15px;">FreeRTOS</a> <a href="/tags/汽车电子/" style="font-size: 15px;">汽车电子</a> <a href="/tags/统一诊断服务UDS/" style="font-size: 15px;">统一诊断服务UDS</a> <a href="/tags/LIN/" style="font-size: 15px;">LIN</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/05/01/QRS/S3C2440/解析S3C2440第一个C程序的内部机制/">解析S3C2440第一个C程序的内部机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/SoftWare_skills/Finite_State_Machine/状态机/">有限状态机,</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/SoftWare_skills/Finite_State_Machine/用状态机原理进行软件设计——FSM概念/">用状态机原理进行软件设计——FSM概念</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/14/QRS/AutomotiveSoftware/Diagnostic/统一诊断服务/">汽车控制器(ECU)统一诊断服务基础知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/04/QRS/AutomotiveSoftware/Diagnostic/汽车ECU诊断基本概念/">汽车ECU诊断基本概念</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/04/QRS/AutomotiveSoftware/LIN/LIN总线诊断的实现/">LIN学习——LIN总线诊断的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/03/QRS/AutomotiveSoftware/Diagnostic/CAN诊断基础知识/">CAN诊断基础知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/20/QRS/AutomotiveSoftware/LIN/LIN学习——LIN应用层/">QRS/AutomotiveSoftware/LIN/LIN学习——LIN应用层</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/20/QRS/AutomotiveSoftware/LIN/LIN学习——工作流/">LIN学习——工作流</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/19/QRS/AutomotiveSoftware/LIN/LIN学习——LIN描述文件/">QRS/AutomotiveSoftware/LIN/LIN学习——LIN描述文件</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">yphfree的学习笔记.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>