<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Bootloader | yphfree的学习笔记</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Bootloader</h1><a id="logo" href="/.">yphfree的学习笔记</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Bootloader</h1><div class="post-meta">May 10, 2017<span> | </span><span class="category"><a href="/categories/嵌入式开发学习笔记/">嵌入式开发学习笔记</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#经典蓝牙和蓝牙BLE的区别"><span class="toc-number">1.</span> <span class="toc-text">经典蓝牙和蓝牙BLE的区别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#蓝牙4-0BLE协议与协议栈的关系"><span class="toc-number">2.</span> <span class="toc-text">蓝牙4.0BLE协议与协议栈的关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#如何使用蓝牙4-0BLE协议栈"><span class="toc-number">3.</span> <span class="toc-text">如何使用蓝牙4.0BLE协议栈</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#深入理解蓝牙4-0BLE协议栈"><span class="toc-number"></span> <span class="toc-text">深入理解蓝牙4.0BLE协议栈</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#协议栈概述"><span class="toc-number">1.</span> <span class="toc-text">协议栈概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BLE蓝牙协议栈结构低"><span class="toc-number">2.</span> <span class="toc-text">BLE蓝牙协议栈结构低</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#任务调度—OSAL操作系统抽象层"><span class="toc-number">3.</span> <span class="toc-text">任务调度—OSAL操作系统抽象层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#设备改造—HAL硬件抽象层"><span class="toc-number">4.</span> <span class="toc-text">设备改造—HAL硬件抽象层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BLE低功耗蓝牙系统架构"><span class="toc-number">5.</span> <span class="toc-text">BLE低功耗蓝牙系统架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#蓝牙4-0BLE协议栈分层思想的优点"><span class="toc-number">6.</span> <span class="toc-text">蓝牙4.0BLE协议栈分层思想的优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#蓝牙4-0BLE协议栈开发平台配置"><span class="toc-number">7.</span> <span class="toc-text">蓝牙4.0BLE协议栈开发平台配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OSAL操作系统抽象层"><span class="toc-number"></span> <span class="toc-text">OSAL操作系统抽象层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#常用术语"><span class="toc-number">1.</span> <span class="toc-text">常用术语</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OSAL运行机理"><span class="toc-number">2.</span> <span class="toc-text">OSAL运行机理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OSAL消息队列"><span class="toc-number">3.</span> <span class="toc-text">OSAL消息队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OSAL添加新任务"><span class="toc-number">4.</span> <span class="toc-text">OSAL添加新任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OSAL应用编程接口-API："><span class="toc-number">5.</span> <span class="toc-text">OSAL应用编程接口 API：</span></a></li></ol></div></div><div class="post-content"><h4 id="经典蓝牙和蓝牙BLE的区别"><a href="#经典蓝牙和蓝牙BLE的区别" class="headerlink" title="经典蓝牙和蓝牙BLE的区别"></a>经典蓝牙和蓝牙BLE的区别</h4><p>说起蓝牙，大家一定听过蓝牙1.0 2.0 3.0 4.0，不过现在已经不再用版本号区分蓝牙了，蓝牙1.0~3.0都是经典蓝牙，在塞班系统就已经开始使用了，确实很经典。有些人一直认为蓝牙4.0就是蓝牙BLE，其实是错误的。因为4.0是双模的，既包括经典蓝牙又包括低能耗蓝牙。经典蓝牙和蓝牙BLE虽然都是蓝牙，但其实还是存在很大区别的。蓝牙BLE相比于经典蓝牙的优点是搜索、连接的速度更快，关键就是BLE(Bluetooth Low Energy)低能耗，缺点呢就是传输的速度慢，传输的数据量也很小，每次只有20个字节。但是蓝牙BLE因为其低能耗的优点，在智能穿戴设备和车载系统上的应用越来越广泛。</p>
<hr>
<h4 id="蓝牙4-0BLE协议与协议栈的关系"><a href="#蓝牙4-0BLE协议与协议栈的关系" class="headerlink" title="蓝牙4.0BLE协议与协议栈的关系"></a>蓝牙4.0BLE协议与协议栈的关系</h4><ul>
<li><p>协议定义的是一系列的通信标准，通信双方需要共同按照这一标准进行正常的数据收发。</p>
</li>
<li><p>协议栈是协议的具体实现形式，通俗的理解为用代码实现的函数库，以便于开发人员调用。</p>
</li>
</ul>
<p>蓝牙4.0BLE协议栈就是将各个层定义的协议都集合在一起，以函数的形式实现，并提供一些应用层API，供用户调用。</p>
<p><strong>注意</strong>：虽然协议是统一的，但是协议的具体实现形式是变化的，即不同厂商提供的协议栈是有区别的，例如：函数名称和参数列表可能有区别，选择协议栈以后，需要学习具体的例子，查看厂商提供的Demo演示程序、说明文档（通常，实现协议栈的厂商会提供一些API手册供用户查询）来学习各个函数的使用方式，进而快速地使用协议栈进行应用程序的开发工作。</p>
<hr>
<h4 id="如何使用蓝牙4-0BLE协议栈"><a href="#如何使用蓝牙4-0BLE协议栈" class="headerlink" title="如何使用蓝牙4.0BLE协议栈"></a>如何使用蓝牙4.0BLE协议栈</h4><p>既然蓝牙4.0BLE协议栈已经实现了蓝牙4.0BLE协议，那么用户就可以使用协议栈提供的API进行应用程序的开发，在开发过程中不必过多的关注蓝牙4.0BLE协议的具体实现细节，只需要关注一个核心的问题：应用程序数据从哪里来到哪里去。</p>
<p>至于调用协议栈中函数后，如何初始化应用进行数据发送等工作，蓝牙4.0BLE协议栈已经完成了所需要的初始化。</p>
<p>如果开发过程中确实需要或者是想要了解蓝牙4.0BLE协议，可以查看SIG提供的标准协议规范。</p>
<h3 id="深入理解蓝牙4-0BLE协议栈"><a href="#深入理解蓝牙4-0BLE协议栈" class="headerlink" title="深入理解蓝牙4.0BLE协议栈"></a>深入理解蓝牙4.0BLE协议栈</h3><h4 id="协议栈概述"><a href="#协议栈概述" class="headerlink" title="协议栈概述"></a>协议栈概述</h4><p>我们以TI的CC254X系列BLE芯片为例来深入了解下蓝牙4.0BLE协议栈。TI的蓝牙4.0BLE协议栈包含两部分：主机和控制器。主机和控制器的分离要追溯到蓝牙BR/EDR设备时期，控制器和主机通常会分开实现。</p>
<p>协议栈的实现方式采用分层的思想，</p>
<ul>
<li><p>控制器部分包括：物理层、链路层、主机控制接口层；</p>
</li>
<li><p>主机部分包括：逻辑链路控制及自适应协议层、安全管理层、属性协议层、通用访问配置文件层、通用属性配置文件层。</p>
</li>
</ul>
<p>上层可以调用下层提供的函数来实现需要的功能。</p>
<h4 id="BLE蓝牙协议栈结构低"><a href="#BLE蓝牙协议栈结构低" class="headerlink" title="BLE蓝牙协议栈结构低"></a>BLE蓝牙协议栈结构低</h4><p>功耗蓝牙协议栈包含两部分共8层：主机（Host）和控制器（Controller）。 </p>
<p>控制器部分包括：</p>
<ul>
<li>物理层（Physical Layer）</li>
<li>链路层（Link Layer）</li>
<li>主机控制接口层（Host Controller Interface）</li>
</ul>
<p>主机部分包括：</p>
<ul>
<li>L2CAP 逻辑链路控制及自适应协议层（Logical Link Control and Adaptation Protocol）</li>
<li>安全管理层（Security Manager）</li>
<li>ATT 属性协议层（Attribute Protocol）</li>
<li>GAP 通用访问配置文件层（Generic Access Profile）</li>
<li>GATT 通用属性配置文件层（Generic Attribute Profile）</li>
</ul>
<p><strong>蓝牙系统核心包括射频收发器，基带和协议栈。</strong></p>
<p><strong>核心系统协议 包括射频(RF)协议、链路控制(LC)协议、链路管理 (LM)协议、逻辑链路的控制和适配 (L2CAP)协议。</strong></p>
<p><strong>蓝牙核心系统最底三层是射频，链路控制，链路管理协议，</strong>通常会把这三者归为一个子系统——蓝牙控制器。把往上的其他层一起称为为蓝牙主机。在蓝牙控制器和蓝牙主机之间实现通信通常需要有主机-控制器接口，Host to Controller Interface(HCI)。蓝牙系统的具体应用apps，就是建立在蓝牙主机之上。而host部分由蓝牙软件厂商开发和维护，control部分由蓝牙的硬件厂商提供，两部分通过hci(主机控制器接口)进行通信和数据交互。</p>
<p><strong>Direct Test Mode</strong><br>厂商提供的测试模块，可以通过HCI或者串口直接控制蓝牙的物理层来让它收发数据包</p>
<p><strong>Physical Layer（PHY）物理层</strong><br>负责数据和语音的发送和接收，特点是短距离、低功耗。蓝牙天线一般体积小、重量轻，属于微带天线。<br>1Mbps自适应跳频GFSK（高斯频移键控），运行在免费的工业频段2.4GHz。</p>
<p><strong>Link Layer（LL）链路层</strong><br>LL层为RF控制器，控制设备处于准备（standby）、广播、监听/扫描（scan）、初始化、连接，这五种状态中一种。<br>五种状态切换描述为：未连接时，设备广播信息，另外一个设备一直监听或按需扫描，两个设备连接初始化，设备连接上了。<br>发起聊天的设备为主设备，接受聊天的设备为从设备，同一次聊天只能有一个意见领袖，即主设备和从设备不能切换。</p>
<p><strong>Host-Controller Interface（HCI）主机控制器接口</strong><br>HCI层为接口层，向上为主机提供软件应用程序接口（API），对外为外部硬件控制接口，可以通过串口、SPI、USB来实现设备控制。</p>
<p><strong>L2CAP逻辑链路控制和适配协议</strong><br>L2CAP层提供数据封装服务，允许逻辑上的点对点通讯。<br>基于包的协议，将包传输到HCI，对于无主机系统，就将包传给链路管理器LM。支持多路复用，包的分割和重组，以及向上层协议提交服务质量信息。</p>
<p><strong>Security Manager（SM）安全管理</strong><br>SM层提供配对和密匙分发，实现安全连接和数据交换。</p>
<p><strong>Attribute Protocal（ATT）属性协议</strong><br>ATT层负责数据检索，允许设备向另外一个设备展示一块特定的数据称之为属性，在ATT环境中，展示属性的设备称之为服务器，与它配对的设备称之为客户端。链路层状态（主机和从机）与设备的ATT角色是相互独立的。例如：主机设备既可以是ATT服务器，也可以是ATT客户端；从机设备既可以是ATT服务器，也可以是ATT客户端。</p>
<p><strong>Generic Attribute Profile（GATT）通用属性协议</strong><br>GATT层定义了使用 ATT 的服务框架和配置文件（profiles）的结构。BLE 中所有的数据通信都需要经过GATT。<br>它定义两个 BLE 设备通过叫做 Service 和 Characteristic 的东西进行通信。GATT 就是使用了 ATT（Attribute Protocol）协议，ATT 协议把 Service, Characteristic遗迹对应的数据保存在一个查找表中，次查找表使用 16 bit ID 作为每一项的索引。</p>
<p>当两个设备建立连接之后，它们就处于下面两种角色之一：<br>GATT服务器：为GATT客户端提供数据服务的设备。<br>GATT客户端：从GATT服务器读写应用数据的设备。</p>
<p><strong>Generic Access Profile（GAP）通用访问协议</strong><br>GAP直接与应用程序或配置文件（profiles）通信的接口，处理设备发现和连接相关服务。另外还处理安全特性的初始化。对上级，提供应用程序接口，对下级，管理各级职能部门，尤其是指示LL层控制室五种状态切换，指导保卫处做好机要工作。GAP给设备定义了若干角色，其中主要的两个是：外围设备（Peripheral）和中心设备（Central）。</p>
<hr>
<pre><code>PHY层，工作车间，1Mbps自适应跳频GFSK（高斯频移键控），运行在免证的2.4GHz

LL层为RF控制器，控制室，控制设备处于准备（standby）、广播、监听/扫描（scan）、初始化、连接，这五种状态中一种。五种状态切换描述为：未连接时，设备广播信息（向周围邻居讲“我来了”），另外一个设备一直监听或按需扫描（看看有没有街坊邻居家常里短可聊，打招呼“哈，你来啦”），两个设备连接初始化（搬几把椅子到院子），设备连接上了（开聊）。发起聊天的设备为主设备，接受聊天的设备为从设备，同一次聊天只能有一个意见领袖，即主设备和从设备不能切换。

 HCI层，为接口层，通信部，向上为主机提供软件应用程序接口（API），对外为外部硬件控制接口，可以通过串口、SPI、USB来实现设备控制。

L2CAP层，物流部，行李打包盒拆封处，提供数据封装服务

SM层，保卫处，提供配对和密匙分发，实现安全连接和数据交换

ATT层，库房，负责数据检索

GATT层，出纳/库房前台，出纳负责处理向上与应用打交道，而库房前台负责向下把检索任务子进程交给ATT库房去做，其关键工作是把为检索工作提供合适的profile结构，而profile由检索关键词（characteristics）组成。

GAP层，秘书处，对上级，提供应用程序接口，对下级，管理各级职能部门，尤其是指示LL层控制室五种状态切换，指导保卫处做好机要工作。

https://blog.csdn.net/ooakk/article/details/7302425
</code></pre><hr>
<h4 id="任务调度—OSAL操作系统抽象层"><a href="#任务调度—OSAL操作系统抽象层" class="headerlink" title="任务调度—OSAL操作系统抽象层"></a>任务调度—OSAL操作系统抽象层</h4><p>正如一个公司为了实现扩大产能和产品多样化，建立了多个办公室和工厂一样，蓝牙为了实现同多个设备相连，或实现多功能，也实现了功能扩充，这就产生了调度问题。因为，虽然软件和协议栈可扩充，但终究最底层的执行部门只有一个。</p>
<p>为了实现多事件和多任务切换，需要把事件和任务对应的应用，以及其相关的提供支撑“办公室”和“工厂”打包起来，并起一个名字OSAL操作系统抽象层，类似于集团公司以下的子公司。</p>
<h4 id="设备改造—HAL硬件抽象层"><a href="#设备改造—HAL硬件抽象层" class="headerlink" title="设备改造—HAL硬件抽象层"></a>设备改造—HAL硬件抽象层</h4><p>如果实现软件和硬件的低耦合，使软件不经改动或很少改动即可应用在另外的硬件上，这样就方便硬件改造、升级、迁移后，软件的移植。HAL硬件抽象层正是用来抽象各种硬件的资源，告知给软件。其作用类似于嵌入式系统设备驱动的定义硬件资源的h头文件。其角色类似于现代工厂的设备管理部。</p>
<h4 id="BLE低功耗蓝牙系统架构"><a href="#BLE低功耗蓝牙系统架构" class="headerlink" title="BLE低功耗蓝牙系统架构"></a>BLE低功耗蓝牙系统架构</h4><p>BLE低功耗蓝牙软件有2个主要组成： OSAL操作系统抽象层和 HAL硬件抽象层，多个Task任务和事件在OSAL管理下工作，而每个任务和事件又包括3个组成：BLE 协议栈，profiles和应用程序。</p>
<h4 id="蓝牙4-0BLE协议栈分层思想的优点"><a href="#蓝牙4-0BLE协议栈分层思想的优点" class="headerlink" title="蓝牙4.0BLE协议栈分层思想的优点"></a>蓝牙4.0BLE协议栈分层思想的优点</h4><p>蓝牙4.0BLE协议栈采用分层思路的最大优点是：将服务、接口和协议这三个概念明确的区分开来。服务说明某一层为上一层提供了一些什么样的功能；接口说明上一层如何使用下一层的服务；而协议涉及到如何实现本层的服务。这样，各层之间就具有很强的独立性，当协议的一部分发送变化时，只需对与此相关的分层进行修改即可，其他分层不需要改变。</p>
<h4 id="蓝牙4-0BLE协议栈开发平台配置"><a href="#蓝牙4-0BLE协议栈开发平台配置" class="headerlink" title="蓝牙4.0BLE协议栈开发平台配置"></a>蓝牙4.0BLE协议栈开发平台配置</h4><p><strong>单一设备</strong></p>
<p><strong>网络处理器</strong></p>
<h3 id="OSAL操作系统抽象层"><a href="#OSAL操作系统抽象层" class="headerlink" title="OSAL操作系统抽象层"></a>OSAL操作系统抽象层</h3><p>OSAL功能：协议栈中所谓的OSAL就是一个小型的操作系统，实现了最基本的任务轮询。</p>
<p>任务注册，初始化，启动<br>任务间的同步，互斥<br>中断处理<br>存储器分配管理<br>提供定时器功能       </p>
<h4 id="常用术语"><a href="#常用术语" class="headerlink" title="常用术语"></a>常用术语</h4><ul>
<li>资源</li>
<li>共享资源</li>
<li>任务</li>
<li>多任务运行</li>
<li>内核</li>
<li>互斥</li>
<li>消息队列</li>
</ul>
<h4 id="OSAL运行机理"><a href="#OSAL运行机理" class="headerlink" title="OSAL运行机理"></a>OSAL运行机理</h4><p>蓝牙4.0 BLE中事件和任务的处理采用方法是：     </p>
<ul>
<li>建立事件表，保存各任务对应的事件，    </li>
<li><p>建立函数表，保存各任务事件处理函数的地址。 </p>
</li>
<li><p>通过不断的查询事件表来判断是否有事件发生，如果有事件发生，则查找函数表找到对应的事件处理函数对事件进行处理。</p>
</li>
<li>事件表使用数组来实现，数组每一项对应一个事件的任务，每一位表示一个事件；</li>
<li>函数表使用函数指针数组来实现，数组的每一项就是一个函数指针，指向了事件处理函数。</li>
</ul>
<p><strong>重要变量：</strong></p>
<ul>
<li>tasksCnt : 任务总个数</li>
<li>tasksEvents: 指向事件表的指针</li>
<li>taskArr : 函数指针数组，指向事件处理函数</li>
</ul>
<p>各种初始化—运行操作系统—有任务触发—执行任务</p>
<hr>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">int</span> <span class="selector-tag">main</span>(void)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">HAL_BOARD_INIT</span>();</span><br><span class="line">  <span class="selector-tag">InitBoard</span>( OB_COLD );</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">HalDriverInit</span>();</span><br><span class="line">  <span class="selector-tag">osal_snv_init</span>(); </span><br><span class="line">  <span class="selector-tag">osal_init_system</span>();</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">HAL_ENABLE_INTERRUPTS</span>();</span><br><span class="line"> </span><br><span class="line">  <span class="selector-tag">InitBoard</span>( OB_READY );</span><br><span class="line"> </span><br><span class="line">  <span class="selector-id">#if</span> <span class="selector-tag">defined</span> ( POWER_SAVING )</span><br><span class="line">    <span class="selector-tag">osal_pwrmgr_device</span>( PWRMGR_BATTERY );</span><br><span class="line">  <span class="selector-id">#endif</span></span><br><span class="line">    </span><br><span class="line">  <span class="selector-tag">osal_start_system</span>(); <span class="comment">// No Return from here       /启动系统</span></span><br><span class="line"> </span><br><span class="line">  <span class="selector-tag">return</span> <span class="selector-tag">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主函数一进去就是各种系统初始化：包括硬件、GATT、 GAP 层、任务等的初始化。然后执行 osal_start_system();操作系统。我们重点关心2 个函数：</p>
<ul>
<li><p>初始化操作系统        osal_init_system()                     </p>
</li>
<li><p>运行操作系统         sal_start_system()                        </p>
</li>
</ul>
<p><strong>osal_init_system()</strong></p>
<p>系统初始化函数，进入函数。发现里面有 6个初始化函数，这里我们只关心osalInitTasks();任务初始化函数。继续由该函数进入，进入后发现终于看到各层任务的添加，taskID 依次递增表示优先级降低，即越底层优先级越高（LL、HAL、HCI、L2CAP、GAP、GATT、SM、Profiles、Application）,最高层即应用层优先级最低，最后执行应用层的任务初始化。</p>
<p>第二个函数 osal_start_system();运行操作系统。同样用 go to definition 的方法进入该函数。再进入 osal_run_system() ，我们欣喜地发现这里就是任务轮询的基本轮廓，源码和分析如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">osal_run_system</span><span class="params">( <span class="keyword">void</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint8 idx = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HAL_BOARD_CC2538</span></span><br><span class="line">  osalTimeUpdate();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  </span><br><span class="line">  Hal_ProcessPoll();</span><br><span class="line">  <span class="comment">//这段代码扫描触发的任务</span></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tasksEvents[idx]) <span class="comment">//优先级高的任务被置位，说明有任务触发 </span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">break</span>;<span class="comment">//跳出任务扫描，得到的idx即为任务ID！</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (++idx &lt; tasksCnt);<span class="comment">//idx从0开始递增，先查询高优先级的任务</span></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (idx &lt; tasksCnt)</span><br><span class="line">  &#123;</span><br><span class="line">    uint16 events;</span><br><span class="line">    halIntState_t intState;</span><br><span class="line">    <span class="comment">//然后进入临界保护区，提取事件后清清除</span></span><br><span class="line">    HAL_ENTER_CRITICAL_SECTION(intState);</span><br><span class="line">    events = tasksEvents[idx];</span><br><span class="line">    tasksEvents[idx] = <span class="number">0</span>;  <span class="comment">// 清除</span></span><br><span class="line">    HAL_EXIT_CRITICAL_SECTION(intState);</span><br><span class="line">    <span class="comment">//然后通过函数指针调用对应的任务处理函数</span></span><br><span class="line">    activeTaskID = idx;</span><br><span class="line">    events = (tasksArr[idx])( idx, events );</span><br><span class="line">    activeTaskID = TASK_NO_TASK;</span><br><span class="line">    <span class="comment">//taskArr[]即为函数指针数组，存放所有定义好的处理任务函数的入口地址</span></span><br><span class="line">    HAL_ENTER_CRITICAL_SECTION(intState);</span><br><span class="line">    tasksEvents[idx] |= events;  <span class="comment">// 保存未处理的事件</span></span><br><span class="line">    HAL_EXIT_CRITICAL_SECTION(intState);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined( POWER_SAVING )<span class="comment">//如果定义了节能模式</span></span></span><br><span class="line">  <span class="keyword">else</span>  </span><br><span class="line">  &#123;</span><br><span class="line">    osal_pwrmgr_powerconserve();  <span class="comment">//进入睡眠</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined (configUSE_PREEMPTION) &amp;&amp; (configUSE_PREEMPTION == 0)</span></span><br><span class="line">  &#123;</span><br><span class="line">    osal_task_yield();</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="OSAL消息队列"><a href="#OSAL消息队列" class="headerlink" title="OSAL消息队列"></a>OSAL消息队列</h4><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typeedef struct</span><br><span class="line">&#123;</span><br><span class="line">	void    *next<span class="comment">;</span></span><br><span class="line">	uint16   len<span class="comment">;</span></span><br><span class="line">	uint8    dest_id<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">&#125; osal_msg_hdr_t<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>从消息队列得到一个消息：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pMsg</span> = osal_msg_receive( simpleBLETASKId )</span><br></pre></td></tr></table></figure></p>
<h4 id="OSAL添加新任务"><a href="#OSAL添加新任务" class="headerlink" title="OSAL添加新任务"></a>OSAL添加新任务</h4><ul>
<li>新任务的初始化函数</li>
<li>新任务的事件处理函数</li>
</ul>
<h4 id="OSAL应用编程接口-API："><a href="#OSAL应用编程接口-API：" class="headerlink" title="OSAL应用编程接口 API："></a>OSAL应用编程接口 API：</h4><ul>
<li>消息管理</li>
<li>任务同步</li>
<li>时间管理</li>
<li>中断管理</li>
<li>任务管理</li>
<li>内存管理</li>
<li>电源管理</li>
<li>非易失性闪存管理</li>
</ul>
</div><div class="tags"><a href="/tags/嵌入式基础知识/">嵌入式基础知识</a></div><div class="post-nav"><a class="pre" href="/2017/05/10/QRS/Basic/bootloader/">Bootloader</a><a class="next" href="/2017/02/15/QRS/Basic/Nand-Flash-Nor-Flash-SDRAM总结/">Nand Flash, Nor Flash, SDRAM总结</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android学习笔记/">Android学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CC2540/">CC2540</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C语言学习/">C语言学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/FreeRTOS/">FreeRTOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Numpy学习笔记/">Numpy学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PyQt5快速开发与实战/">PyQt5快速开发与实战</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python学习笔记/">Python学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ROS-Kinetic学习笔记/">ROS_Kinetic学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/STM32学习笔记/">STM32学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/单片机/">单片机</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/嵌入式开发学习笔记/">嵌入式开发学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/硬件学习笔记/">硬件学习笔记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/STM32基础/" style="font-size: 15px;">STM32基础</a> <a href="/tags/C-算法/" style="font-size: 15px;">C 算法</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Python3/" style="font-size: 15px;">Python3</a> <a href="/tags/ROS-Kinetic/" style="font-size: 15px;">ROS_Kinetic</a> <a href="/tags/锂电池/" style="font-size: 15px;">锂电池</a> <a href="/tags/C51/" style="font-size: 15px;">C51</a> <a href="/tags/STM32项目/" style="font-size: 15px;">STM32项目</a> <a href="/tags/硬件基础/" style="font-size: 15px;">硬件基础</a> <a href="/tags/PyQt5/" style="font-size: 15px;">PyQt5</a> <a href="/tags/Python-Numpy/" style="font-size: 15px;">Python Numpy</a> <a href="/tags/嵌入式基础知识-通信协议/" style="font-size: 15px;">嵌入式基础知识 通信协议</a> <a href="/tags/嵌入式基础知识-硬件基础知识/" style="font-size: 15px;">嵌入式基础知识 硬件基础知识</a> <a href="/tags/嵌入式基础知识/" style="font-size: 15px;">嵌入式基础知识</a> <a href="/tags/通信协议/" style="font-size: 15px;">通信协议</a> <a href="/tags/CC2540/" style="font-size: 15px;">CC2540</a> <a href="/tags/FreeRTOS/" style="font-size: 15px;">FreeRTOS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/25/QRS/Wireless_Protocol/蓝牙4.0BLE协议栈技术入门/">QRS/Wireless_Protocol/蓝牙4.0BLE协议栈技术入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/25/QRS/Wireless_Protocol/蓝牙4.0BLE应用实例/">QRS/Wireless_Protocol/蓝牙4.0BLE应用实例</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/13/Android/Android学习笔记6——文件存储/">Android学习笔记6——文件存储</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/10/Python/numpy/Numpy学习笔记/">Numpy学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/21/ROS/ROS_Kinetic学习笔记：2、ROS基础内容/">ROS_Kinetic学习笔记：2、ROS_Kinetic基础知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/20/ROS/ROS_Kinetic学习笔记：1、ROS安装、环境配置与测试/">ROS_Kinetic学习笔记：1、ROS安装、环境配置与测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/16/Python/Python 网络编程/">Python3</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/16/Python/Python 3 正则表达式/">Python3基础  正则表达式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/24/UAV/无人机基础知识总结/">无人机基础知识总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/20/RTOS/FreeRTOS/FreeRTOS 内存管理/">FreeRTOS 内存管理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">yphfree的学习笔记.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>